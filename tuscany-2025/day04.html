<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tuscany 2025 — Day 4</title>

  <!-- Leaflet CSS (cache-busted) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css?v=4" />

  <style>
    :root { --brand:#0b7285; --ink:#0b1b22; --muted:#718096; --bg:#f8fafc; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--ink);background:var(--bg);}
    header{padding:1rem;background:white;border-bottom:1px solid #e5e7eb;position:sticky;top:0}
    .crumbs a{color:var(--muted);text-decoration:none}.crumbs a:hover{color:var(--brand)}
    h1{margin:0.25rem 0 0.5rem;font-size:1.5rem}
    .wrap{max-width:1100px;margin:0 auto;padding:1rem}
    #map{height:70vh;border-radius:16px;border:1px solid #e5e7eb}
    .toolbar{display:flex;gap:.75rem;align-items:center;margin:.5rem 0 1rem}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.6rem .9rem;border-radius:999px;border:1px solid #e5e7eb;background:white;text-decoration:none;color:var(--ink)}
    .btn:hover{border-color:#cbd5e1}
    .pill{font-size:.85rem;color:var(--brand);border-color:var(--brand)}
    .stats{display:flex;gap:1rem;flex-wrap:wrap;color:#334155;font-size:.95rem}
    .stat{background:white;border:1px solid #e5e7eb;border-radius:12px;padding:.5rem .75rem}
    .hint{color:#64748b;font-size:.9rem;margin:.25rem 0 .75rem}
    footer{color:var(--muted);font-size:.9rem;padding:2rem 1.25rem}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="crumbs"><a href="/">Home</a> › <a href="/tuscany-2025/">Tuscany 2025</a> › Day 4</div>
      <h1>Day 4 — Tuscany Tour</h1>
      <p class="muted">Interactive route map and GPX download.</p>
    </div>
  </header>

  <main class="wrap">
    <div class="toolbar">
      <a class="btn pill" href="./assets/gpx/day04.gpx?v=4" download>Download GPX</a>
      <span class="muted">Load time may vary on mobile.</span>
    </div>

    <div class="stats">
      <div class="stat">Distance: <strong id="stat-distance">—</strong></div>
      <div class="stat">Ascent: <strong id="stat-ascent">—</strong></div>
      <div class="stat">Descent: <strong id="stat-descent">—</strong></div>
      <div class="stat">Moving Time: <strong id="stat-time">—</strong></div>
    </div>

    <p class="hint" id="statusHint"></p>
    <div id="map"></div>
  </main>

  <footer class="wrap">© VALR Adventures — Tuscany 2025</footer>

  <!-- JS libraries (cache-busted) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js?v=4"></script>
  <script src="https://unpkg.com/@mapbox/togeojson@0.16.0/dist/togeojson.min.js?v=4"></script>
  <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js?v=4"></script>

  <script>
    // Base map
    const map = L.map('map', { zoomControl: true }).setView([43.77, 11.25], 7);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // GPX route (cache-busted)
    const gpxUrl = './assets/gpx/day04.gpx?v=4';

    const routeLayer = L.geoJson(null, {
      style: { color: '#0b7285', weight: 4, opacity: 0.9 }
    });

    omnivore.gpx(gpxUrl, null, routeLayer)
      .on('ready', function() {
        map.fitBounds(routeLayer.getBounds(), { padding: [20,20] });
        try {
          const km = computeGeoJsonDistanceKm(routeLayer.toGeoJSON());
          if (isFinite(km)) document.getElementById('stat-distance').textContent = km.toFixed(1) + ' km';
        } catch (_) {}
        document.getElementById('statusHint').textContent = '';
      })
      .on('error', function() {
        document.getElementById('statusHint').textContent =
          'Route failed to render. Convert GPX to <trk>/<trkseg> if needed.';
      })
      .addTo(map);

    function computeGeoJsonDistanceKm(geo) {
      const toRad = d => d * Math.PI / 180;
      const R = 6371; let total = 0;

      function addLine(coords) {
        for (let i = 1; i < coords.length; i++) {
          const [lon1, lat1] = coords[i-1], [lon2, lat2] = coords[i];
          const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
          const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
          total += 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
      }

      if (geo.type === 'FeatureCollection') {
        geo.features.forEach(f => {
          const g = f.geometry; if (!g) return;
          if (g.type === 'LineString') addLine(g.coordinates);
          if (g.type === 'MultiLineString') g.coordinates.forEach(addLine);
        });
      } else if (geo.type === 'Feature') {
        const g = geo.geometry;
        if (g.type === 'LineString') addLine(g.coordinates);
        if (g.type === 'MultiLineString') g.coordinates.forEach(addLine);
      }
      return total;
    }
  </script>
</body>
</html>
