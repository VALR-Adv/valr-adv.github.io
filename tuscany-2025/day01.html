<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tuscany 2025 — Day 1</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <style>
    :root { --brand:#0b7285; --ink:#0b1b22; --muted:#718096; --bg:#f8fafc; }
    body{margin:0;font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;color:var(--ink);background:var(--bg);} 
    header{padding:1rem 1.25rem;background:white;border-bottom:1px solid #e5e7eb;position:sticky;top:0}
    .crumbs a{color:var(--muted);text-decoration:none}
    .crumbs a:hover{color:var(--brand)}
    h1{margin:0.25rem 0 0.5rem;font-size:1.5rem}
    .wrap{max-width:1100px;margin:0 auto;padding:1rem}
    #map{height:70vh;border-radius:16px;border:1px solid #e5e7eb}
    .toolbar{display:flex;gap:.75rem;align-items:center;margin:.5rem 0 1rem}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.6rem .9rem;border-radius:999px;border:1px solid #e5e7eb;background:white;text-decoration:none;color:var(--ink)}
    .btn:hover{border-color:#cbd5e1}
    .pill{font-size:.85rem;color:var(--brand);border-color:var(--brand)}
    .stats{display:flex;gap:1rem;flex-wrap:wrap;color:#334155;font-size:.95rem}
    .stat{background:white;border:1px solid #e5e7eb;border-radius:12px;padding:.5rem .75rem}
    .hint{color:#64748b;font-size:.9rem;margin:.25rem 0 .75rem}
    footer{color:var(--muted);font-size:.9rem;padding:2rem 1.25rem}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="crumbs"><a href="/">Home</a> › <a href="/tuscany-2025/">Tuscany 2025</a> › Day 1</div>
      <h1>Day 1 — Tuscany Tour</h1>
      <p class="muted">Interactive route map and GPX download.</p>
    </div>
  </header>
  <main class="wrap">
    <div class="toolbar">
      <a class="btn pill" id="downloadLink" href="./assets/gpx/day01.gpx" download>Download GPX</a>
      <span class="muted">Load time may vary on mobile.</span>
    </div>
    <div class="stats" id="stats">
      <div class="stat">Distance: <strong id="stat-distance">—</strong></div>
      <div class="stat">Ascent: <strong id="stat-ascent">—</strong></div>
      <div class="stat">Descent: <strong id="stat-descent">—</strong></div>
      <div class="stat">Moving Time: <strong id="stat-time">—</strong></div>
    </div>
    <p class="hint" id="statusHint"></p>
    <div id="map"></div>
  </main>
  <footer class="wrap">© VALR Adventures — Tuscany 2025</footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet-gpx@1.7.0/gpx.min.js"></script>
  <script>
    const map = L.map('map', { zoomControl: true });

    // Fallback center/zoom (Tuscany area) so tiles show even before GPX draws
    map.setView([43.77, 11.25], 7);

    // Single-host OSM tiles (avoids some blockers)
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const gpxUrl = './assets/gpx/day01.gpx';

    const gpxLayer = new L.GPX(gpxUrl, {
      async: true,
      // Ensure routes are parsed even if there's no <trk>
      gpx_options: { parseElements: ['track','route'] },
      // Make the line easy to see
      polyline_options: { color: '#0b7285', weight: 4, opacity: 0.9 },
      marker_options: {
        startIconUrl: 'https://unpkg.com/leaflet-gpx/pin-icon-start.png',
        endIconUrl: 'https://unpkg.com/leaflet-gpx/pin-icon-end.png',
        shadowUrl: 'https://unpkg.com/leaflet-gpx/pin-shadow.png'
      }
    })
    .on('loaded', e => {
      map.fitBounds(e.target.getBounds(), { padding: [20,20] });

      const dist = e.target.get_distance();
      if (dist && isFinite(dist)) {
        document.getElementById('stat-distance').textContent = (dist/1000).toFixed(1) + ' km';
      }
      const eg = e.target.get_elevation_gain?.();
      const el = e.target.get_elevation_loss?.();
      if (isFinite(eg)) document.getElementById('stat-ascent').textContent = Math.round(eg) + ' m';
      if (isFinite(el)) document.getElementById('stat-descent').textContent = Math.round(el) + ' m';

      const msec = e.target.get_total_time?.();
      document.getElementById('stat-time').textContent = msec ? new Date(msec).toISOString().substr(11,8) : '—';

      document.getElementById('statusHint').textContent = '';
    })
    .on('error', () => {
      document.getElementById('statusHint').textContent = 'Could not render the GPX line. The file downloaded fine, but it may contain only unsupported elements. If this persists, I can convert it to a standard track.';
      document.getElementById('stat-distance').textContent = '—';
    })
    .addTo(map);
  </script>
</body>
</html>
